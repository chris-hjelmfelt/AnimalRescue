<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <title>Animal Rescue Simulator</title>
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
</head>
<body>  
  <script src="pixi.min.js"></script>  
  <script src="levels/facility.js"></script>
  <script src="levels/streets.js"></script>
  <script src="levels/dirt.js"></script>
  <script src="levels/city.js"></script>
  <script src="player.js"></script>
  <script src="animals.js"></script>
  <script src="menus.js"></script>
  <script src="collision.js"></script>
  <script src="keyboard.js"></script>
  <script type="text/javascript">
    let type = "WebGL"
    if(!PIXI.utils.isWebGLSupported()){
      type = "canvas"
    }
		
		//Aliases
		let Application = PIXI.Application,
				loader = PIXI.loader,
				resources = PIXI.loader.resources,
				Sprite = PIXI.Sprite;
				Rectangle = PIXI.Rectangle;

		//Create a Pixi Applirocketion
		let app = new Application({ 
				width: 1030, 
				height: 702,                       
				antialias: true, 
				transparent: false, 
				resolution: 1
			}
		);

		//Add the canvas that Pixi automatically created for you to the HTML document
		document.body.appendChild(app.view);

		//load an image and run the `setup` function when it's done
		loader
      .add("facility.jpg")
      .add("streets.png")
      .add("citydirt.png")
      .add("city2.png")
      .add("player.png")
      .add("van.png")
      .add("menu.png")
      .add("animalsprites.png")
      .add("wallsprites.png")
			.load(setup);

    let state, facility, streets, message, player, van, menu, dog1, cat, dirt, city;
    let walls = [];
    let currLocation = 'facility';
    let debounce1 = false;
    let debounce2 = false;
    let debounceN = false, debounceE = false, debounceS = false, debounceW = false;
		
		//This `setup` function will run when the image has loaded
		function setup() {		
      // start main level	
      addFacility();
      // listen for keyboard input
      keyboardStart();
  
      // load level2
      addStreets();
      addDirt();
      addCity();

      // Make sure these functions come after the others in the order they are placed here
      $.ajax({ data : 'x', url  : 'x',  
      complete : addPlayer() //called when AJAX transaction finishes 
      }); 
      $.ajax({ data : 'x', url  : 'x',  
      complete : addAnimals() //called when AJAX transaction finishes 
      }); 
      $.ajax({ data : 'x', url  : 'x',  
      complete : addMenus()//called when AJAX transaction finishes 
      });      

      hideStreets();
			//Set the game state
			state = play;
      
			//Start the game loop by adding the `gameLoop` function to
			//Pixi's `ticker` and providing it with a `delta` argument.
      app.ticker.add(delta => gameLoop(delta));
      
		}   


		function gameLoop(delta){
			//Update the current game state:
			state(delta);
		}


		function play(delta) {
      // check for collision with walls
      let playID = setTimeout( () => {movePlayer()}, 50)
      
      if (streets.visible) {
        let animalID = setTimeout( () => {moveAnimal(dog1)}, 40)
      }
      
      // check van is gone
      if (van.position.x < -200) {
        clearInterval(tID);
        hideFacility();
        player.visible = true;
        if (currLocation == 'streets') {
          showStreets();
          dog1.visible = true;
        } else if (currLocation == 'dirt'){
          dirt.visible = true;
          player.y = 520;
        } else {
          city.visible = true;          
          player.y = 520;
        }        
        van.position.x = 15;  // without this we can't close streets and this if statement will keep running
      }
    } // end of play function
     
    function movePlayer() {
      // check for obstactles before moving
      let newPlayerX = player.x + player.vx;
      let newPlayerY = player.y + player.vy;
      let collided = wallColisions(player);
	    			
      //Use the player's velocity to make them move
      if (collided == false) {
        player.x = newPlayerX;
        player.y = newPlayerY;
        debounceN = false, debounceE = false, debounceS = false, debounceW = false;
      } else {
        if (debounceN == false){
          debounceN = true;
          player.y -= 5;
        } else if (debounceE == false){
          debounceE = true;
          player.y += 5;
          player.x += 5;
        } else if (debounceS == false){
          debounceS = true;
          player.x -= 5;
          player.y += 5;
        } else if (debounceW == false){
          debounceW = true;
          player.y -= 5;
          player.x -= 5;
        } else {
          player.x = streetLocX;
          player.y = streetLocY;
        }
      }

      // check for a collision between the player and the animals
      if (hitTestRectangle(player, dog1)) {
        message.text = "Touching";
        debounce2 = true;
      } else if (hitTestRectangle(player, cat)){
        message.text = "Touching";
        debounce2 = true;
      } else if (hitTestRectangle(player, van)) {
        if (debounce2 == false && van.visible == true){
          menu.visible = true;
        }
        debounce2 = true;
      } else {
        debounce2 = false;
        message.text = "";
      }	

      // stop player at edges
			if (player.x > 970)			
        player.x = 970;
      if (player.y > 640)  
        player.y = 640;
      if (player.x < 0)			
        player.x = 0;
      if (player.y < 90)  
        player.y = 90;
    }

    function moveVan() {
      tID = setInterval ( () => {van.position.x -= 5}, 20)            
    }

  </script>
</body>
</html>